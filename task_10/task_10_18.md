# Домашнее задание 10

**Выполнил - Третьяков Александр Юрьевич**

## Упражение 18

### Задание
Самостоятельно ознакомьтесь с таким средством работы
с таблицами базы данных, как курсоры (`cursors`). Воспользуйтесь технической документацией на `PostgreSQL`, глава `«PL/pgSQL – SQL
Procedural Language»`. Напишите небольшую функцию с применением
курсора.

### Решение
Напишем функцию с курсором для расчета зарплатного фонда по отделам
```sql
CREATE OR REPLACE FUNCTION calculate_department_salary_stats()
RETURNS TABLE(department_head VARCHAR
             ,employee_count INTEGER
             ,total_salary DECIMAL
             ,avg_salary DECIMAL) AS
$$
DECLARE
    -- Курсор для группировки по начальникам (отделам)
    dept_cursor CURSOR FOR
        SELECT 
            b.emp_name as boss_name,
            COUNT(*) as emp_count,
            SUM(oc.salary) as total_sal,
            AVG(oc.salary) as avg_sal
        FROM Org_chart oc
        LEFT JOIN Personnel b ON oc.boss_emp_nbr = b.emp_nbr
        WHERE oc.boss_emp_nbr IS NOT NULL
        GROUP BY b.emp_name
        ORDER BY total_sal DESC;
    
    dept_record RECORD;
BEGIN    
    -- Открываем курсор
    OPEN dept_cursor;
    
    LOOP
        -- Получаем данные отдела
        FETCH dept_cursor INTO dept_record;
        EXIT WHEN NOT FOUND;
        
        -- Заполняем возвращаемые значения
        department_head := dept_record.boss_name;
        employee_count := dept_record.emp_count;
        total_salary := dept_record.total_sal;
        avg_salary := ROUND(dept_record.avg_sal, 2);
        
        
        RETURN NEXT;
    END LOOP;
    
    -- Закрываем курсор
    CLOSE dept_cursor;
    
END;
$$
LANGUAGE plpgsql;
```

Проверим выполнение
```sql
SELECT * FROM calculate_department_salary_stats();
```

<img src="./assets/ex_18/2025-11-24 210341.jpg" width="700">