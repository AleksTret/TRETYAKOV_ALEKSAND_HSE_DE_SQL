# Домашнее задание 10

**Выполнил - Третьяков Александр Юрьевич**

## Упражение 13

### Задание
Выполните проверку структуры дерева на предмет отсутствия циклов с помощью функции `tree_test()`.
```sql
SELECT * FROM tree_test();
```
Если вы еще не вносили изменения в таблицу «Организационная
структура», то функция покажет отсутствие нарушения структуры
дерева. Теперь создайте в таблице «Организационная структура» сначала короткий цикл, а затем длинный цикл. Для каждого из указанных
циклов выполните проверку с помощью функции `tree_test()`.
### Решение

Проверим исходную структуру дерева

```bash
sudo -u postgres psql -d ais -c "SELECT tree_test()"
```

<img src="./assets/ex_13/2025-11-24 191954.jpg" width="700">

Создание короткого цикла
Короткий цикл - когда работник становится своим же начальником:

Для начала временно отключим ограничения предотвращающее короткие циклы
```bash
sudo -u postgres psql -d ais -c "ALTER TABLE Org_chart DROP CONSTRAINT org_chart_check"
```

Создаем короткий цикл (работник становится своим начальником)
```bash
sudo -u postgres psql -d ais -c "UPDATE Org_chart SET boss_emp_nbr = 2 WHERE emp_nbr = 2"
```
Проверяем наличие цикла

```bash
sudo -u postgres psql -d ais -c "SELECT tree_test()"
```

Ожидаемый результат: Cycles (обнаружены циклы)

<img src="./assets/ex_13/2025-11-24 192716.jpg" width="700">

Смотрим измененную структуру

```bash
sudo -u postgres psql -d ais -c "SELECT emp_nbr, emp, boss_emp_nbr FROM Personnel_org_chart WHERE emp_nbr = 2"
```

<img src="./assets/ex_13/2025-11-24 193011.jpg" width="700">

Удаляем короткий цикл
```bash
sudo -u postgres psql -d ais -c "UPDATE Org_chart SET boss_emp_nbr = 1 WHERE emp_nbr = 2"
```

Восстанавливаем ограничение
```bash
sudo -u postgres psql -d ais -c "ALTER TABLE Org_chart ADD CHECK ((boss_emp_nbr <> emp_nbr) OR (boss_emp_nbr = 0 AND emp_nbr = 0))"
```

Финальная проверка
```bash
sudo -u postgres psql -d ais -c "SELECT tree_test()"
```

Ожидаемый результат: Tree

<img src="./assets/ex_13/2025-11-24 193308.jpg" width="700">

Создадим длинный цикл `2 -> 6 -> 3 -> 2`
```bash
sudo -u postgres psql -d ais -c "UPDATE Org_chart SET boss_emp_nbr = 6 WHERE emp_nbr = 2"

sudo -u postgres psql -d ais -c "UPDATE Org_chart SET boss_emp_nbr = 3 WHERE emp_nbr = 6"

sudo -u postgres psql -d ais -c "UPDATE Org_chart SET boss_emp_nbr = 2 WHERE emp_nbr = 3"
```

Ожидаемый результат: Cycles 

<img src="./assets/ex_13/2025-11-24 193821.jpg" width="700">

Посмотрим изменненную структуру

```bash
sudo -u postgres psql -d ais -c "SELECT emp_nbr, emp, boss_emp_nbr FROM Personnel_org_chart ORDER BY emp_nbr"
```

<img src="./assets/ex_13/2025-11-24 200609.jpg" width="700">

Восстановим исходную структуру и проверим

<img src="./assets/ex_13/2025-11-24 201023.jpg" width="700">
