# Домашнее задание 5

**Выполнил - Третьяков Александр Юрьевич**

## Упражение 19

### Задание
В разделе `6.4` мы использовали рекурсивный алгоритм в общем табличном выражении. Изучите этот пример, чтобы лучше понять работу рекурсивного алгоритма:
```sql
WITH RECURSIVE ranges ( min_sum, max_sum )
AS (
        VALUES( 0, 100000 ),
              ( 100000, 200000 ),
              ( 200000, 300000 )
    UNION ALL
    SELECT min_sum + 100000, max_sum + 100000
    FROM ranges
    WHERE max_sum < ( SELECT max( total_amount ) FROM bookings )
    )
SELECT * FROM ranges;

min_sum  | max_sum
---------+---------
0        | 100000 исходные строки
100000   | 200000
200000   | 300000
100000   | 200000 результат первой итерации
200000   | 300000
300000   | 400000
200000   | 300000 результат второй итерации
300000   | 400000
400000   | 500000
300000   | 400000
400000   | 500000
500000   | 600000
...
1000000  | 1100000 результат (n-3)-й итерации
1100000  | 1200000
1200000  | 1300000
1100000  | 1200000 результат (n-2)-й итерации
1200000  | 1300000
1200000  | 1300000 результат (n-1)-й итерации (предпоследней)
(36 строк)
```

Здесь мы с помощью предложения `VALUES` специально создали виртуальную
таблицу из трех строк, хотя для получения требуемого результата достаточно только одной строки `(0, 100000)`. Еще важно то, что предложение `UNION ALL` не
удаляет строки-дубликаты, поэтому мы можем видеть весь рекурсивный процесс порождения новых строк.
При рекурсивном выполнении запроса
```sql
SELECT min_sum + 100000, max_sum + 100000
FROM ranges
WHERE max_sum < ( SELECT max( total_amount ) FROM bookings )
```
каждый раз выполняется проверка в условии `WHERE`. И на `(n−2)`-й итерации это
условие отсеивает одну строку, т. к. после `(n − 3)`-й итерации значение атрибута
`max_sum` в третьей строке было равно `1 300 000`.
Ведь запрос
```sql
SELECT max( total_amount ) FROM bookings;
```
выдаст значение
```sql
   max
----------
1204500.00
(1 строка)
```
Таким образом, после `(n − 2)`-й итерации во временной области остается всего
две строки, после `(n−1)`-й итерации во временной области остается только одна
строка.
Заключительная итерация уже не добавляет строк в результирующую таблицу,
поскольку единственная строка, поданная на вход команде `SELECT`, будет отклонена условием `WHERE`. Работа алгоритма завершается.

**Задание 1**. Модифицируйте запрос, добавив в него столбец `level` (можно назвать его и `iteration`). Этот столбец должен содержать номер текущей итерации, поэтому нужно увеличивать его значение на единицу на каждом шаге. Не
забудьте задать начальное значение для добавленного столбца в предложении
`VALUES`.

**Задание 2**. Для завершения экспериментов замените `UNION ALL` на `UNION` и
выполните запрос. Сравните этот результат с предыдущим, когда мы использовали `UNION ALL`.

### Решение