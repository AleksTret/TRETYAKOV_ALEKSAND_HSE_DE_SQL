# Домашнее задание 9

**Выполнил - Третьяков Александр Юрьевич**

## Упражение 6

### Задание
Выполните команду `EXPLAIN` для запроса, в котором использована какая нибудь из оконных функций. Найдите в плане выполнения запроса узел с именем `WindowAgg`. Попробуйте объяснить, почему он занимает именно этот уровень в плане.

### Решение

Возьмем для примера следующий запрос

```sql
EXPLAIN ANALYZE
SELECT 
    flight_id,
    amount,
    AVG(amount) OVER (PARTITION BY flight_id) as avg_flight_price
FROM ticket_flights
WHERE amount > 10000;
```

<img src="./assets/ex_6/2025-11-21 214839.jpg" width="900">

Структура выполнения
```
WindowAgg  (cost=99871.50..111847.36 rows=684335 width=42)
  ->  Sort  (cost=99871.50..101582.34 rows=684335 width=10)
        Sort Key: flight_id
        ->  Seq Scan on ticket_flights  (cost=0.00..21847.58 rows=684335 width=10)
              Filter: (amount > 10000)
```              

`WindowAgg` занимает именно этот уровень потому что оконная функция 
`AVG(amount) OVER (PARTITION BY flight_id)` требует:

- Данные, сгруппированные по `flight_id` 
- Внутри каждой партиции - все строки для вычисления `AVG`
- Добавляет новый столбец `avg_flight_price`

Таким образом `WindowAgg` находится на самом верхнем уровне, потому что это финальный обработчик - получает отсортированные данные и больше никуда их не передает 
