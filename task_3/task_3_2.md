# Домашнее задание 3

**Выполнил - Третьяков Александр Юрьевич**

## Упражение 2

### Задание

Посмотрите, какие ограничения уже наложены на атрибуты таблицы «Успеваемость» (`progress`). Воспользуйтесь командой `\d` утилиты `psql`. А теперь предложите для этой таблицы ограничение уровня таблицы.
В качестве примера рассмотрим такой вариант. Добавьте в таблицу `progress`
еще один атрибут — «Форма проверки знаний» (`test_form`), который может
принимать только два значения: «экзамен» или «зачет». Тогда набор допустимых значений атрибута «Оценка» (`mark`) будет зависеть от того, экзамен или зачет предусмотрены по данной дисциплине. Если предусмотрен экзамен, тогда
допускаются значения `3, 4, 5`, если зачет — тогда `0` (не зачтено) или `1` (зачтено).Не забудьте, что значения `NULL` для атрибутов `test_form` и `mark` не допускаются.
Новое ограничение может быть таким:
```sql
ALTER TABLE progress
ADD CHECK (
( test_form = 'экзамен' AND mark IN ( 3, 4, 5 ) )
OR
( test_form = 'зачет' AND mark IN ( 0, 1 ) )
);
```
Проверьте, как будет работать новое ограничение в модифицированной таблице `progress`. Для этого выполните команды `INSERT`, как удовлетворяющие ограничению, так и нарушающие его.
В таблице уже было ограничение на допустимые значения атрибута `mark`. Как
вы думаете, не будет ли оно конфликтовать с новым ограничением? Проверьте
эту гипотезу. Если ограничения конфликтуют, тогда удалите старое ограничение и снова попробуйте добавить строки в таблицу.
Подумайте, какое еще ограничение уровня таблицы можно предложить для
этой таблицы?

### Решение

Проверим ограничения на полях таблицы `progres`

<img src="./assets/ex_2/2025-11-03 091426.jpg" width="900" >

Добавим поле `test_form` и зададим ему ограничения

<img src="./assets/ex_2/2025-11-03 092309.jpg" width="450" >

Добавим тестовых студентов

<img src="./assets/ex_2/2025-11-03 092942.jpg" width="700" >

Добавим оценки для студентов.

Ограничение `progress_mark_check`, конфликтует с новыми требованиями. Новое ограничение допускает оценки `0` и `1` для зачетов, но старое ограничение их блокирует.
```sql
CHECK ( mark >= 3 AND mark <= 5 )
```
<img src="./assets/ex_2/2025-11-03 094027.jpg" width="700" >

Удалим ограничение и добавим оценку 

<img src="./assets/ex_2/2025-11-03 094432.jpg" width="700" >

Протестируем невалидные вставки в таблицу `progress`
- Экзамен с оценкой для зачета:
- Зачет с оценкой для экзамена:
- Недопустимая форма проверки:
- Значение `NULL` в `test_form`:

<img src="./assets/ex_2/2025-11-03 094849.jpg" width="700" >

Добавим новое ограничение - уникальность записи о сдаче предмета.
```sql
ALTER TABLE progress 
ADD UNIQUE (record_book, subject, acad_year, term);
```
<img src="./assets/ex_2/2025-11-03 095510.jpg" width="700" >

**Проверим валидные случаи**

- Разные студенты - один предмет:

<img src="./assets/ex_2/2025-11-03 095806.jpg" width="700" >

- Один студент - разные предметы:

<img src="./assets/ex_2/2025-11-03 095953.jpg" width="700" >

- Один студент - один предмет, но разные семестры:

<img src="./assets/ex_2/2025-11-03 100130.jpg" width="700" >

- Один студент - один предмет, но разные учебные годы:

<img src="./assets/ex_2/2025-11-03 100258.jpg" width="700" >

Содержимое таблицы `progress` после вставок

<img src="./assets/ex_2/2025-11-03 100446.jpg" width="700" >

**Проверим невалидные случаи**

- Дублирование полной записи:

<img src="./assets/ex_2/2025-11-03 100813.jpg" width="800" >

- Попытка изменить только форму сдачи: ошибка потому что,
`test_form` не входит в уникальный ключ.

<img src="./assets/ex_2/2025-11-03 101014.jpg" width="800" >

Добавим еще одно ограничение - список допустимых предметов

```sql
ALTER TABLE progress 
ADD CHECK (
    subject IN (
        'Математика',
        'Физика', 
        'Программирование',
        'Базы данных',
        'Физкультура',
        'История'
    )
);
```
**Проверим невалидные случаи**

- 1 Предмета нет в списке разрешенных

<img src="./assets/ex_2/2025-11-03 102330.jpg" width="800" >


- 2 Опечатка в названии: например -> "Математека" ≠ "Математика"

<img src="./assets/ex_2/2025-11-03 102518.jpg" width="800" >

**Валидный случай**

<img src="./assets/ex_2/2025-11-03 102814.jpg" width="800" >

<img src="./assets/ex_2/2025-11-03 102919.jpg" width="800" >